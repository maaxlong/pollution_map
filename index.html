<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map with Multiple Filters</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .filter-buttons {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
            font-family: 'Arial', sans-serif;
            display: flex;
            font-size: 10px;
            justify-content: center;
        }
        .filter-button {
            display: inline-block;
            margin: 0 5px;
            padding: 10px;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }
        #btn-woollen {
            background-color: #FF6347; /* Tomato Red */
        }
        #btn-dyers {
            background-color: #4682B4; /* Steel Blue */
        }
        #btn-other {
            background-color: #32CD32; /* Lime Green */
        }
        #btn-all {
            background-color: #FFD700; /* Gold */
        }
    </style>
</head>
<body>

    <div id="map-container">
        <div id="map"></div>
        <div class="filter-buttons">
            <div id="btn-woollen" class="filter-button">Woollen & Worsted Manufacturers</div>
            <div id="btn-dyers" class="filter-button">Dyers and Sizers</div>
            <div id="btn-other" class="filter-button">Other</div>
            <div id="btn-all" class="filter-button">All</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([53.7912497, -1.7442514], 10);  // Center the map on Bradford

        // Define the OS 1908 25-inch map tile layer
        var os1908Layer = L.tileLayer('https://mapseries-tilesets.s3.amazonaws.com/25_inch/yorkshire/{z}/{x}/{y}.png', {
            attribution: '© National Library of Scotland',
            maxZoom: 18
        });

        // Define the Modern-day OpenStreetMap tile layer
        var modernDayLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        });

        // Set the default layer when the map loads (e.g., OS 1908)
        os1908Layer.addTo(map);

        // Create a layer control and add it to the map
        var baseMaps = {
            "OS 1908 25-inch": os1908Layer,
            "Modern-day OpenStreet Map": modernDayLayer
        };

        L.control.layers(baseMaps).addTo(map);
        
        // URL to the rivers GeoJSON file
        var riversGeojsonUrl = 'https://raw.githubusercontent.com/maaxlong/pollution_map/refs/heads/main/data/1852_becks_26_Sept.geojson';
        
        // Variable to store the rivers layer for later filtering
        var riversLayer;
        
        // Fetch and add the rivers GeoJSON
// Fetch and add the rivers GeoJSON
fetch(riversGeojsonUrl)
    .then(response => response.json())
    .then(data => {
        // Create a new GeoJSON layer for rivers
        riversLayer = L.geoJson(data, {
            style: function (feature) {
                return {
                    color: "#00BFFF",  // Initial line color for rivers
                    weight: 3,         // Line thickness
                    opacity: 0.7       // Line opacity
                };
            },
            onEachFeature: function (feature, layer) {
                // Extract the river name from the feature properties
                var riverName = feature.properties.Name || 'Unnamed River';

                // Add a tooltip that only shows on hover
                layer.bindTooltip(riverName, {
                    permanent: false,  // Show only on hover
                    direction: "center",  // Center the tooltip over the line
                    className: "river-label"
                });

                // Event listeners for highlighting
                layer.on('mouseover', function () {
                    layer.setStyle({
                        color: "darkblue",  // Change to dark blue on hover
                        weight: 8,          // Thicker line on hover
                        opacity: 1
                    });
                });

                // Reset style on mouseout
                layer.on('mouseout', function () {
                    riversLayer.resetStyle(layer);  // Reset to default style
                });
            }
        }).addTo(map);

        // Fit the map bounds to show all rivers initially
        map.fitBounds(riversLayer.getBounds());
    })
    .catch(err => console.error('Error loading rivers GeoJSON: ', err));

        // URL to the GeoJSON file hosted on GitHub
        var geojsonUrl = 'https://raw.githubusercontent.com/maaxlong/pollution_map/refs/heads/main/data/sept_26_v4.geojson';

        var geojsonLayer;  // To store the loaded GeoJSON layer

        // Function to get marker color based on business category
        function getMarkerColor(businessCategory) {
            switch (businessCategory) {
                case 'Woollen & Worsted Manufacturers':
                    return '#FF6347';  // Tomato Red
                case 'Dyers and Sizers':
                    return '#4682B4';  // Steel Blue
                default:
                    return '#32CD32';  // Lime Green for 'Other'
            }
        }

        // Fetch the GeoJSON file
        fetch(geojsonUrl)
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJson(data, {
                    pointToLayer: function(feature, latlng) {
                        var businessCategory = feature.properties.business_category || 'Other';
                        var markerColor = getMarkerColor(businessCategory);

                        return L.circleMarker(latlng, {
                            radius: 4,
                            fillColor: markerColor,
                            color: "#000",  // Border color
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
onEachFeature: function (feature, layer) {
                // Extract properties
                var name = feature.properties.name || 'N/A';
                var businessType = feature.properties.business_type || 'N/A';
                var businessCategory = feature.properties.business_category || 'Other';
                var nominalHorsePower = feature.properties.nominal_horse_power || 'N/A';
                var usesDyes = feature.properties.uses_dyes !== undefined ? (feature.properties.uses_dyes ? 'Yes' : 'No') : 'N/A';
                var usesBleaching = feature.properties.uses_bleaching_materials !== undefined ? (feature.properties.uses_bleaching_materials ? 'Yes' : 'No') : 'N/A';
                var affectedByFloods = feature.properties.affected_by_floods !== undefined ? (feature.properties.affected_by_floods ? 'Yes' : 'No') : 'N/A';
                var situatedOnWatercourse = feature.properties.beck || 'N/A';

                // Status of river comments
                var statusOfRiverComments = feature.properties.status_of_river_comments || 'No comments';

                // Soapsuds: Check if the soapsuds property exists and is valid
                var soapsuds = feature.properties.soapsuds && typeof feature.properties.soapsuds === 'object' ? feature.properties.soapsuds : null;
                var treatedForGrease = soapsuds && soapsuds.treated_for_recovery_of_grease !== undefined ? (soapsuds.treated_for_recovery_of_grease ? 'Yes' : 'No') : 'N/A';

                // Oils: Check if oils is an array and valid
                var oils = Array.isArray(feature.properties.oils) && feature.properties.oils.length > 0 ? feature.properties.oils : null;
                var oilInfo = 'No oils used';
                if (oils) {
                    oilInfo = oils.map(oil => {
                        var oilType = oil.oil_type || 'Unknown oil';
                        var quantity = oil.quantity || 'N/A';
                        var unit = oil.quantity_measured_in || '';
                        var value = oil.value || 'N/A';
                        return `${oilType}: ${quantity} ${unit} (${value} value)`;
                    }).join('<br>');
                }

                // Water supplies: Check if water_supplies is an object or an array
                var waterSupplies = feature.properties.water_supplies;
                var waterSources = 'No water sources';

                if (waterSupplies) {
                    if (Array.isArray(waterSupplies)) {
                        // If water_supplies is an array
                        waterSources = waterSupplies.map(function(supply) {
                            return supply.source_of_water || 'Unknown source';
                        }).join(', ');
                    } else if (typeof waterSupplies === 'object') {
                        // If water_supplies is a single object
                        waterSources = waterSupplies.source_of_water || 'Unknown source';
                    }
                }

                // Popup content
                var popupContent = '<b>' + name + '</b><br>' +
                                   'Business Type: ' + businessType + '<br>' +
                                   'Business Category: ' + businessCategory + '<br>' +
                                   'Horse Power: ' + nominalHorsePower + '<br>' +
                                   'Uses Dyes: ' + usesDyes + '<br>' +
                                   'Uses Bleaching Materials: ' + usesBleaching + '<br>' +
                                   'Affected by Floods: ' + affectedByFloods + '<br>' +
                                   'Watercourse: ' + situatedOnWatercourse + '<br>' +
                                   'Status of River: ' + statusOfRiverComments + '<br>' +
                                   'Treated for Grease (soapsuds): ' + treatedForGrease + '<br>' +
                                   'Oils: ' + oilInfo + '<br>' +
                                   'Water Sources: ' + waterSources;

                layer.bindPopup(popupContent);
            }
        }).addTo(map);
        map.fitBounds(geojsonLayer.getBounds());
    })
    .catch(err => console.error('Error loading GeoJSON: ', err));

        // Function to filter data based on category
        function filterByCategory(category) {
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }

            fetch(geojsonUrl)
                .then(response => response.json())
                .then(data => {
                    var filteredFeatures = category === 'All' 
                        ? data.features 
                        : data.features.filter(function (feature) {
                            return feature.properties.business_category === category;
                        });

                    geojsonLayer = L.geoJson({
                        "type": "FeatureCollection",
                        "features": filteredFeatures
                    }, {
                        pointToLayer: function(feature, latlng) {
                            var businessCategory = feature.properties.business_category || 'Other';
                            var markerColor = getMarkerColor(businessCategory);

                            return L.circleMarker(latlng, {
                                radius: 4,
                                fillColor: markerColor,
                                color: "#000",
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        },
                        onEachFeature: function (feature, layer) {
                            var name = feature.properties.name || 'N/A';
                            var businessType = feature.properties.business_type || 'N/A';
                            var businessCategory = feature.properties.business_category || 'Other';
                            var nominalHorsePower = feature.properties.nominal_horse_power || 'N/A';

                            // Popup content
                            var popupContent = '<b>' + name + '</b><br>' +
                                               'Business Type: ' + businessType + '<br>' +
                                               'Business Category: ' + businessCategory + '<br>' +
                                               'Horse Power: ' + nominalHorsePower;

                            layer.bindPopup(popupContent);
                        }
                    }).addTo(map);

                    map.fitBounds(geojsonLayer.getBounds());
                })
                .catch(err => console.error('Error loading filtered GeoJSON: ', err));
        }

        // Attach event listeners to the buttons
        document.getElementById('btn-woollen').addEventListener('click', function() {
            filterByCategory('Woollen & Worsted Manufacturers');
        });

        document.getElementById('btn-dyers').addEventListener('click', function() {
            filterByCategory('Dyers and Sizers');
        });

        document.getElementById('btn-other').addEventListener('click', function() {
            filterByCategory('Other');
        });

        document.getElementById('btn-all').addEventListener('click', function() {
            filterByCategory('All');
        });
    </script>
</body>
</html>
